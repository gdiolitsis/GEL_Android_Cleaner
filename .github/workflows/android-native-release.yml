name: Build Android APK/AAB (Native, Signed)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
            distribution: temurin
            java-version: '17'

      - name: Install Android SDK
        run: |
          ANDROID_HOME=$HOME/android-sdk
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          mkdir -p "$ANDROID_HOME/cmdline-tools"
          cd "$ANDROID_HOME/cmdline-tools"
          curl -s https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o tools.zip
          unzip -q tools.zip -d latest
          rm tools.zip
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      - name: Install Gradle 8.5
        run: |
          wget -q https://services.gradle.org/distributions/gradle-8.5-bin.zip
          unzip -q gradle-8.5-bin.zip
          sudo mv gradle-8.5 /opt/gradle
          echo "/opt/gradle/bin" >> $GITHUB_PATH
          gradle -v

      # ⚠️ Needs secrets: KEYSTORE_BASE64, KEYSTORE_PASSWORD, KEY_ALIAS, KEY_ALIAS_PASSWORD
      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > forestrock-release.keystore
          ls -l forestrock-release.keystore

      - name: Build Release (APK & AAB)
        env:
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
        run: |
          /opt/gradle/bin/gradle clean :app:assembleRelease :app:bundleRelease

      - name: Sign APK
        run: |
          APK=$(find app/build/outputs/apk/release -name "*release*.apk" | head -n1)
          echo "APK=$APK"
          mkdir -p Signed
          ${ANDROID_HOME}/build-tools/34.0.0/zipalign -f 4 "$APK" Signed/GEL-aligned.apk
          ${ANDROID_HOME}/build-tools/34.0.0/apksigner sign \
            --ks forestrock-release.keystore \
            --ks-pass pass:"${{ secrets.KEYSTORE_PASSWORD }}" \
            --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
            --key-pass pass:"${{ secrets.KEY_ALIAS_PASSWORD }}" \
            --out Signed/GEL-signed.apk \
            Signed/GEL-aligned.apk
          ${ANDROID_HOME}/build-tools/34.0.0/apksigner verify Signed/GEL-signed.apk
          ls -lh Signed

      - name: Collect AAB
        run: |
          ls -lh app/build/outputs/bundle/release || true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: GEL_Native_Build
          path: |
            Signed/GEL-signed.apk
            app/build/outputs/bundle/release/*.aab
          if-no-files-found: error
