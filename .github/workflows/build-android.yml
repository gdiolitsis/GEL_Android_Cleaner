name: Build Android APK (Cordova) â€” Release Signed

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # -------------------------------------------------------------
    # Checkout
    # -------------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------------------------------------------------
    # Java + Android SDK
    # -------------------------------------------------------------
    - name: Prepare environment
      run: |
        sudo apt-get update -y
        sudo apt-get install -y openjdk-17-jdk unzip curl wget
        echo "JAVA_HOME=$(dirname $(dirname $(readlink -f $(which javac))))" >> $GITHUB_ENV
        echo "ANDROID_HOME=/usr/local/lib/android/sdk" >> $GITHUB_ENV
        echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH

    # -------------------------------------------------------------
    # GRADLE â€” (unchanged)
    # -------------------------------------------------------------
    - name: Install Gradle 8.5
      run: |
        wget https://services.gradle.org/distributions/gradle-8.5-bin.zip
        unzip -q gradle-8.5-bin.zip
        sudo mv gradle-8.5 /opt/gradle
        echo "/opt/gradle/bin" >> $GITHUB_PATH
        gradle -v

    # -------------------------------------------------------------
    # ANDROID SDK â€” (unchanged)
    # -------------------------------------------------------------
    - name: Install Android SDK tools
      run: |
        mkdir -p $ANDROID_HOME/cmdline-tools
        cd $ANDROID_HOME/cmdline-tools
        curl -s https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o tools.zip
        unzip -q tools.zip -d latest
        rm tools.zip
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "build-tools;33.0.2" "platforms;android-33"

    # -------------------------------------------------------------
    # Cordova â€” (unchanged)
    # -------------------------------------------------------------
    - name: Install Cordova
      run: npm install -g cordova@12.0.0

    # -------------------------------------------------------------
    # Decode Keystore
    # -------------------------------------------------------------
    - name: Decode Keystore from Secrets
      run: |
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > forestrock-release.keystore
        ls -l forestrock-release.keystore

    # -------------------------------------------------------------
    # Build (APK + AAB)
    # -------------------------------------------------------------
    - name: Build Release
      working-directory: app
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_ALIAS_PASSKRD }}
      run: |
        export PATH=/opt/gradle/bin:$PATH

        cordova platform add android@12 || true
        cordova build android --release --no-update-notifier -- --packageType=apk
        cordova build android --release --no-update-notifier -- --packageType=bundle

    # -------------------------------------------------------------
    # Locate unsigned artifacts
    # -------------------------------------------------------------
    - name: Locate unsigned APK/AAB
      run: |
        find app/platforms/android -type f | grep -E "(release.*(apk|aab))" | tee unsigned.txt
        cat unsigned.txt

    # -------------------------------------------------------------
    # Sign (APK)
    # -------------------------------------------------------------
    - name: Sign APK
      env:
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD }}
      run: |
        APK=$(grep ".apk" unsigned.txt | head -n1)
        mkdir -p Signed
        echo "ðŸ”Ž RAW APK = $APK"

        ZIP_ALIGNED=Signed/GEL-aligned.apk
        FINAL_APK=Signed/GEL-signed.apk

        ${ANDROID_HOME}/build-tools/33.0.2/zipalign -f 4 "$APK" "$ZIP_ALIGNED"
        ${ANDROID_HOME}/build-tools/33.0.2/apksigner sign \
          --ks forestrock-release.keystore \
          --ks-pass pass:"${{ secrets.KEYSTORE_PASSWORD }}" \
          --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
          --key-pass pass:"${{ secrets.KEY_ALIAS_PASSKRD }}" \
          --out "$FINAL_APK" \
          "$ZIP_ALIGNED"

        echo "âœ… SIGNED APK:"
        ls -lh "$FINAL_APK"

    # -------------------------------------------------------------
    # Collect final outputs
    # -------------------------------------------------------------
    - name: Upload FINAL artifacts
      uses: actions/upload-artifact@v4
      with:
        name: GEL_Release_Build
        path: |
          Signed/*.apk
          app/platforms/android/app/build/outputs/bundle/release/*.aab
        if-no-files-found: warn
