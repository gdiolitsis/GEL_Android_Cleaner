# =========================================================
# GDiolitsis Engine Lab (GEL) â€” Author & Developer
# Build: Play-Store-Ready Signed APK (Cordova 12, AGP/SDK 33, Gradle 8.5)
# NOTE: Requires GitHub Secrets:
#  ANDROID_KEYSTORE_BASE64  (base64 of your .keystore)
#  ANDROID_KEYSTORE_ALIAS
#  ANDROID_KEYSTORE_PASSWORD
#  ANDROID_KEY_PASSWORD
# =========================================================

name: Build Android APK (Cordova) â€” Release Signed

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare environment
        run: |
          sudo apt-get update -y
          sudo apt-get install -y openjdk-17-jdk unzip curl wget imagemagick
          echo "JAVA_HOME=$(dirname $(dirname $(readlink -f $(which javac))))" >> $GITHUB_ENV
          echo "ANDROID_HOME=/usr/local/lib/android/sdk" >> $GITHUB_ENV
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH

      - name: Install Gradle 8.5
        run: |
          wget https://services.gradle.org/distributions/gradle-8.5-bin.zip
          unzip -q gradle-8.5-bin.zip
          sudo mv gradle-8.5 /opt/gradle
          echo "/opt/gradle/bin" >> $GITHUB_PATH
          gradle -v

      - name: Install Android SDK tools (platforms;android-33 / build-tools;33.0.2)
        run: |
          mkdir -p $ANDROID_HOME/cmdline-tools
          cd $ANDROID_HOME/cmdline-tools
          curl -s https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o tools.zip
          unzip -q tools.zip -d latest
          rm tools.zip
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "build-tools;33.0.2" "platforms;android-33"

      - name: Install Cordova
        run: npm install -g cordova@12.0.0

      # ðŸ”’ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î¼ÏŒÎ½Î¿: Î¾ÎµÎºÎ¹Î½Î¬Î¼Îµ Ï€Î¬Î½Ï„Î± ÎºÎ±Î¸Î±ÏÎ¬ (Î´ÎµÎ½ Î±Î»Î»Î¬Î¶Ï‰ versions)
      - name: Clean previous build folder
        run: rm -rf GEL_Cleaner

      # ðŸ§± Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Cordova project + assets Î±Ï€ÏŒ /app (ÏŒÏ€Ï‰Ï‚ Ï„Î¿ Î­Ï‡ÎµÎ¹Ï‚ ÏƒÏ„Î¿ repo)
      - name: Create Cordova project & import app assets
        run: |
          cordova create GEL_Cleaner com.gel.cleaner "GEL Android Cleaner"
          cd GEL_Cleaner
          cordova platform add android@12

          # www / config Î±Ï€ÏŒ Ï„Î¿ repo
          mkdir -p www/img
          cp ../app/www/index.html www/index.html || true
          cp -r ../app/www/css www/css || true
          cp -r ../app/www/js  www/js  || true
          cp -r ../app/www/img/* www/img/ || true
          cp ../app/config.xml config.xml || true

          # plugin: local folder Î±Ï€ÏŒ Ï„Î¿ repo ÏŽÏƒÏ„Îµ Î½Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ package.json in-place
          cp -r ../app/cordova-plugin-gelcleaner ./cordova-plugin-gelcleaner
          cordova plugin add ./cordova-plugin-gelcleaner

      # (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ UI asset â€” Î”Î•Î Î±Î»Î»Î¬Î¶ÎµÎ¹ Ï„Î¹Ï‚ versions / build chain)
      - name: Resize GEL logo for launcher icon (optional)
        run: |
          if [ -f "GEL_Cleaner/www/img/GEL_logo.png" ]; then
            cd GEL_Cleaner/www/img
            convert GEL_logo.png -resize 512x512\> GEL_logo_512.png
          fi

      # ðŸ—ï¸ Release build (unsigned Î±Ï€ÏŒ Cordova/Gradle)
      - name: Build Release (unsigned)
        run: |
          cd GEL_Cleaner
          export PATH=/opt/gradle/bin:$PATH
          cordova build android --release --no-update-notifier
          ls -lah platforms/android/app/build/outputs/apk/release || true

      # ðŸ” Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î± Keystore Î±Ï€ÏŒ GitHub Secrets
      - name: Prepare keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          cd GEL_Cleaner
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > release.keystore
          ls -lah release.keystore

      # ðŸ“¦ zipalign + apksign â†’ Ï„ÎµÎ»Î¹ÎºÏŒ Play-Store-ready APK
      - name: Zipalign & Sign APK
        env:
          ANDROID_KEYSTORE_ALIAS: ${{ secrets.ANDROID_KEYSTORE_ALIAS }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cd GEL_Cleaner/platforms/android/app/build/outputs/apk/release

          UNSIGNED="app-release-unsigned.apk"
          ALIGNED="app-release-aligned.apk"
          SIGNED="../../../../../../GEL_Cleaner_release_signed.apk"

          # zipalign
          $ANDROID_HOME/build-tools/33.0.2/zipalign -v -p 4 "$UNSIGNED" "$ALIGNED"

          # sign
          $ANDROID_HOME/build-tools/33.0.2/apksigner sign \
            --ks ../../../../../../release.keystore \
            --ks-key-alias "${ANDROID_KEYSTORE_ALIAS}" \
            --ks-pass env:ANDROID_KEYSTORE_PASSWORD \
            --key-pass env:ANDROID_KEY_PASSWORD \
            --out "$SIGNED" \
            "$ALIGNED"

          # verify
          $ANDROID_HOME/build-tools/33.0.2/apksigner verify --verbose "$SIGNED"

          ls -lah "$SIGNED"

      # ðŸ“¤ Artifact: Ï„Î¿ signed, zipaligned Play-Store-ready APK
      - name: Upload Release APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: GEL_Cleaner_release_signed.apk
          path: GEL_Cleaner/GEL_Cleaner_release_signed.apk
